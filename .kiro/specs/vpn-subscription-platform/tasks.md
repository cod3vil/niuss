# 实施计划：VPN 订阅服务平台

## 概述

本实施计划将 VPN 订阅服务平台的设计转化为可执行的开发任务。系统采用前后端分离架构，后端使用 Rust (Axum)，前端使用 Vue 3 + TypeScript。实施将按照增量方式进行，每个任务都建立在前面的任务之上，确保代码始终处于可集成状态。

## 任务

- [x] 1. 项目初始化和基础设施搭建
  - 创建项目目录结构（api、frontend、admin、node-agent）
  - 配置 Rust 工作空间和依赖（Axum、SQLx、Redis、Serde、JWT）
  - 配置 Vue 3 项目（Vite、TypeScript、Pinia、TailwindCSS）
  - 创建 Docker Compose 配置文件（PostgreSQL、Redis）
  - 创建数据库迁移脚本（所有表结构）
  - _需求：13.1, 13.4, 13.5_

- [x] 2. 实现数据模型和数据库层
  - [x] 2.1 定义 Rust 数据模型结构体
    - 实现 User、Package、Order、Node、Subscription 等模型
    - 添加 Serde 序列化支持
    - 添加 SQLx FromRow 派生
    - _需求：1.1, 2.1, 3.1, 6.1_
  
  - [x] 2.2 编写数据模型属性测试
    - **属性 10：节点配置往返一致性**
    - **验证需求：6.1**
  
  - [x] 2.3 实现数据库访问层
    - 创建数据库连接池
    - 实现用户 CRUD 操作
    - 实现套餐 CRUD 操作
    - 实现订单 CRUD 操作
    - 实现节点 CRUD 操作
    - _需求：1.1, 3.1, 6.1, 9.1_
  
  - [x] 2.4 编写数据库层单元测试
    - 测试 CRUD 操作
    - 测试事务回滚
    - 测试约束验证
    - _需求：1.1, 3.1, 6.1_

- [-] 3. 实现认证和授权模块
  - [x] 3.1 实现密码哈希和验证
    - 使用 argon2 实现密码哈希
    - 实现密码验证函数
    - _需求：14.1_
  
  - [x] 3.2 编写密码安全属性测试
    - **属性 18：密码哈希不可逆性**
    - **验证需求：14.1**
  
  - [x] 3.3 实现 JWT 令牌生成和验证
    - 实现令牌生成函数（包含用户 ID、角色、过期时间）
    - 实现令牌验证中间件
    - 实现令牌刷新逻辑
    - _需求：1.3, 14.2, 14.3_
  
  - [x] 3.4 编写认证属性测试
    - **属性 2：认证令牌有效性**
    - **验证需求：1.3, 1.4, 14.2, 14.3**
  
  - [x] 3.5 实现用户注册和登录 API
    - POST /api/auth/register 端点
    - POST /api/auth/login 端点
    - POST /api/auth/refresh 端点
    - 输入验证（邮箱格式、密码强度）
    - _需求：1.1, 1.3_
  
  - [ ] 3.6 编写注册唯一性属性测试
    - **属性 1：用户注册唯一性**
    - **验证需求：1.1, 1.2**

- [x] 4. 检查点 - 确保认证功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [x] 5. 实现虚拟金币系统
  - [x] 5.1 实现金币余额管理
    - 实现金币充值逻辑
    - 实现金币扣除逻辑
    - 实现余额查询 API（GET /api/user/balance）
    - 实现金币交易记录
    - _需求：2.1, 2.2, 2.3, 2.4_
  
  - [x] 5.2 编写金币余额属性测试
    - **属性 3：金币余额一致性**
    - **验证需求：2.2, 2.3, 2.4**
  
  - [x] 5.3 编写金币不足拒绝属性测试
    - **属性 4：金币余额不足拒绝**
    - **验证需求：2.5**


- [x] 6. 实现流量套餐管理
  - [x] 6.1 实现套餐管理 API
    - GET /api/packages 端点（查询可用套餐）
    - POST /api/packages/:id/purchase 端点（购买套餐）
    - 验证金币余额
    - 创建订单记录
    - _需求：3.1, 3.2_
  
  - [x] 6.2 实现套餐购买逻辑
    - 扣除用户金币
    - 增加用户流量配额
    - 创建 user_packages 记录
    - 使用数据库事务确保一致性
    - _需求：3.2, 3.3_
  
  - [x] 6.3 编写套餐购买属性测试
    - **属性 5：套餐购买流量增加**
    - **验证需求：3.3**
  
  - [x] 6.4 实现订单查询 API
    - GET /api/orders 端点（用户订单列表）
    - GET /api/orders/:id 端点（订单详情）
    - _需求：9.1, 9.3_
  
  - [x] 6.5 编写订单号唯一性属性测试
    - **属性 14：订单号唯一性**
    - **验证需求：9.5**

- [x] 7. 实现推荐返利系统
  - [x] 7.1 实现推荐链接生成
    - 生成唯一推荐码
    - GET /api/user/referral 端点
    - 存储推荐关系
    - _需求：4.1, 4.2_
  
  - [x] 7.2 编写推荐链接唯一性属性测试
    - **属性 6：推荐链接唯一性**
    - **验证需求：4.1**
  
  - [x] 7.3 实现推荐返利逻辑
    - 监听用户首次购买事件
    - 计算返利金额
    - 增加推荐人金币余额
    - 防止自我推荐
    - _需求：4.3, 4.5_
  
  - [x] 7.4 编写推荐返利属性测试
    - **属性 7：推荐返利正确性**
    - **验证需求：4.3**
  
  - [x] 7.5 实现推荐统计 API
    - GET /api/user/referral/stats 端点
    - 返回推荐人数和累计返利
    - _需求：4.4_

- [x] 8. 实现 Redis 缓存层
  - [x] 8.1 配置 Redis 连接
    - 创建 Redis 连接池
    - 实现 Redis 工具函数
    - _需求：15.2, 15.5_
  
  - [x] 8.2 实现用户套餐缓存
    - 缓存用户流量配额和使用情况
    - 实现缓存失效策略（TTL 300 秒）
    - 实现缓存更新逻辑
    - _需求：15.5_
  
  - [x] 8.3 实现节点列表缓存
    - 缓存活跃节点列表
    - TTL 60 秒
    - _需求：15.5_
  
  - [x] 8.4 编写缓存单元测试
    - 测试缓存命中和未命中
    - 测试缓存失效
    - 测试降级到数据库
    - _需求：15.5_

- [x] 9. 检查点 - 确保核心业务逻辑正常
  - 确保所有测试通过，如有问题请询问用户。

- [x] 10. 实现订阅链接和配置生成
  - [x] 10.1 实现订阅链接生成
    - 生成唯一订阅令牌
    - GET /api/subscription/link 端点
    - 存储订阅记录
    - _需求：5.1_
  
  - [x] 10.2 编写订阅链接唯一性属性测试
    - **属性 8：订阅链接唯一性**
    - **验证需求：5.1**
  
  - [x] 10.3 实现 Clash 配置生成器
    - 实现 Shadowsocks 配置生成
    - 实现 VMess 配置生成
    - 实现 Trojan 配置生成
    - 实现 Hysteria2 配置生成
    - 实现 VLESS-Reality 配置生成
    - 生成 YAML 格式输出
    - _需求：11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7_
  
  - [x] 10.4 编写多协议配置属性测试
    - **属性 16：多协议配置生成正确性**
    - **验证需求：11.1-11.7**
  
  - [x] 10.5 编写 Reality 配置完整性属性测试
    - **属性 17：Reality 配置完整性**
    - **验证需求：11.6**
  
  - [x] 10.6 实现订阅端点
    - GET /sub/:token 端点（公开访问）
    - 验证用户套餐有效性
    - 返回 Clash YAML 配置
    - 处理过期和流量耗尽情况
    - _需求：5.2, 5.3, 5.4, 5.5_
  
  - [x] 10.7 编写订阅配置生成属性测试
    - **属性 9：订阅配置生成正确性**
    - **验证需求：5.2, 5.3, 5.5**
  
  - [x] 10.8 实现订阅配置缓存
    - 缓存生成的 Clash 配置
    - TTL 300 秒
    - _需求：15.5_

- [x] 11. 实现节点管理 API
  - [x] 11.1 实现节点 CRUD API
    - GET /api/admin/nodes 端点（节点列表）
    - POST /api/admin/nodes 端点（创建节点）
    - PUT /api/admin/nodes/:id 端点（更新节点）
    - DELETE /api/admin/nodes/:id 端点（删除节点）
    - 验证管理员权限
    - _需求：6.1, 6.2, 6.3, 6.4_
  
  - [x] 11.2 实现节点配置分发
    - 实现配置更新通知（Redis Pub/Sub）
    - GET /api/node/config 端点（Node Agent 拉取配置）
    - 验证节点密钥
    - _需求：6.2, 10.1, 10.2_
  
  - [x] 11.3 实现节点心跳处理
    - POST /api/node/heartbeat 端点
    - 更新节点状态和统计信息
    - 更新 last_heartbeat 时间戳
    - _需求：6.4, 10.5_
  
  - [x] 11.4 编写节点管理单元测试
    - 测试节点创建和更新
    - 测试配置分发
    - 测试心跳处理
    - _需求：6.1, 6.2, 6.4_

- [x] 12. 实现流量统计系统
  - [x] 12.1 实现流量上报接收
    - 配置 Redis Streams 消费者
    - 实现流量数据消费逻辑
    - 批量更新用户流量使用记录
    - _需求：7.2_
  
  - [x] 12.2 实现流量限制检查
    - 实现流量配额验证函数
    - 在订阅端点检查流量配额
    - 流量耗尽时拒绝服务
    - _需求：7.3, 3.4_
  
  - [x] 12.3 编写流量统计属性测试
    - **属性 11：流量统计累加正确性**
    - **验证需求：7.1, 7.2, 7.4**
  
  - [x] 12.4 编写流量超额拒绝属性测试
    - **属性 12：流量超额拒绝服务**
    - **验证需求：7.3**
  
  - [x] 12.5 实现流量查询 API
    - GET /api/user/traffic 端点
    - 返回已使用流量和剩余流量
    - _需求：7.4_
  
  - [x] 12.6 实现流量日志持久化
    - 定时任务：每小时汇总流量数据
    - 写入 traffic_logs 表
    - 清理 Redis 中的临时数据
    - _需求：7.5_

- [x] 13. 检查点 - 确保订阅和流量功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [x] 14. 实现管理后台 API
  - [x] 14.1 实现用户管理 API
    - GET /api/admin/users 端点（用户列表）
    - GET /api/admin/users/:id 端点（用户详情）
    - PUT /api/admin/users/:id/status 端点（启用/禁用用户）
    - PUT /api/admin/users/:id/balance 端点（调整金币）
    - PUT /api/admin/users/:id/traffic 端点（调整流量）
    - _需求：8.1, 8.2, 8.3, 8.4, 8.5_
  
  - [x] 14.2 编写用户状态管理属性测试
    - **属性 13：用户状态管理往返**
    - **验证需求：8.2, 8.3**
  
  - [x] 14.3 实现审计日志记录
    - 记录所有管理员操作到 admin_logs 表
    - 包含操作者、操作类型、目标、时间戳
    - _需求：8.5, 14.4_
  
  - [x] 14.4 编写审计日志属性测试
    - **属性 19：审计日志完整性**
    - **验证需求：8.5, 14.4**
  
  - [x] 14.5 实现订单管理 API
    - GET /api/admin/orders 端点（订单列表，支持过滤）
    - GET /api/admin/orders/:id 端点（订单详情）
    - _需求：9.1, 9.2, 9.3_
  
  - [x] 14.6 实现数据统计 API
    - GET /api/admin/stats/overview 端点（总览统计）
    - GET /api/admin/stats/revenue 端点（收入统计）
    - GET /api/admin/stats/traffic 端点（流量统计）
    - 实现时间范围过滤
    - _需求：12.1, 12.2, 12.3, 12.4, 12.5_
  
  - [x] 14.7 编写订单统计属性测试
    - **属性 15：订单统计聚合正确性**
    - **验证需求：9.4**

- [x] 15. 实现用户前端
  - [x] 15.1 创建前端项目结构
    - 配置 Vue Router（页面路由）
    - 配置 Pinia stores（状态管理）
    - 配置 Axios（HTTP 客户端）
    - 配置 TailwindCSS
    - _需求：1.1_
  
  - [x] 15.2 实现认证页面
    - 注册页面（/register）
    - 登录页面（/login）
    - 实现 authStore（认证状态管理）
    - 实现令牌存储和自动刷新
    - _需求：1.1, 1.3_
  
  - [x] 15.3 实现用户仪表板
    - 仪表板首页（/dashboard）
    - 个人信息页面（/dashboard/profile）
    - 显示金币余额和流量使用情况
    - _需求：2.3, 7.4_
  
  - [x] 15.4 实现套餐购买页面
    - 套餐列表页面（/dashboard/packages）
    - 实现 packageStore
    - 购买确认对话框
    - 金币余额不足提示
    - _需求：3.1, 3.2_
  
  - [x] 15.5 实现订单历史页面
    - 订单列表页面（/dashboard/orders）
    - 订单详情展示
    - _需求：9.1, 9.3_
  
  - [x] 15.6 实现订阅管理页面
    - 订阅链接展示（/dashboard/subscription）
    - 一键复制订阅链接
    - 显示节点列表
    - _需求：5.1_
  
  - [x] 15.7 实现推荐返利页面
    - 推荐链接展示（/dashboard/referral）
    - 推荐统计展示
    - 一键复制推荐链接
    - _需求：4.1, 4.4_

- [x] 16. 实现管理后台前端
  - [x] 16.1 创建管理后台项目结构
    - 配置 Vue Router
    - 配置 Pinia stores
    - 配置 Axios
    - 配置 Ant Design Vue（UI 组件库）
    - _需求：8.1_
  
  - [x] 16.2 实现管理员登录页面
    - 登录页面（/admin/login）
    - 管理员认证
    - _需求：1.3_
  
  - [x] 16.3 实现仪表板页面
    - 数据总览页面（/admin/dashboard）
    - 显示用户总数、活跃用户、总流量、总收入
    - 显示趋势图
    - _需求：12.1, 12.2, 12.4, 12.5_
  
  - [x] 16.4 实现节点管理页面
    - 节点列表页面（/admin/nodes）
    - 节点创建/编辑表单
    - 节点状态展示
    - 节点删除确认
    - _需求：6.1, 6.2, 6.3, 6.4_
  
  - [x] 16.5 实现用户管理页面
    - 用户列表页面（/admin/users）
    - 用户详情页面
    - 启用/禁用用户操作
    - 调整金币和流量操作
    - _需求：8.1, 8.2, 8.3, 8.4, 8.5_
  
  - [x] 16.6 实现订单管理页面
    - 订单列表页面（/admin/orders）
    - 订单过滤功能
    - 订单详情展示
    - _需求：9.1, 9.2, 9.3_
  
  - [x] 16.7 实现数据统计页面
    - 统计页面（/admin/stats）
    - 收入统计图表
    - 流量统计图表
    - 节点统计表格
    - _需求：12.1, 12.2, 12.3_

- [x] 17. 检查点 - 确保前端功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [x] 18. 实现 Node Agent
  - [x] 18.1 创建 Node Agent 项目
    - 配置 Rust 项目和依赖
    - 实现配置文件读取
    - _需求：10.1, 13.4_
  
  - [x] 18.2 编写环境变量配置属性测试
    - **属性 20：环境变量配置正确性**
    - **验证需求：13.4**
  
  - [x] 18.3 实现配置同步模块
    - 启动时向 API 注册
    - 拉取初始配置
    - 监听配置更新通知（Redis Pub/Sub）
    - 应用配置到 Xray-core
    - _需求：10.1, 10.2, 10.3_
  
  - [x] 18.4 实现流量上报模块
    - 从 Xray-core API 获取流量数据
    - 批量上报到 Redis Streams
    - 每 30 秒上报一次
    - _需求：7.1, 7.2_
  
  - [x] 18.5 实现健康检查模块
    - 检查 Xray-core 进程状态
    - 发送心跳到 API 服务
    - 异常时重启 Xray-core
    - _需求：10.4, 10.5_
  
  - [x] 18.6 实现用户管理模块
    - 获取活跃用户列表
    - 动态更新 Xray-core 用户配置
    - 检查用户流量配额
    - _需求：7.3_
  
  - [x] 18.7 编写 Node Agent 集成测试
    - 测试配置同步流程
    - 测试流量上报流程
    - 测试心跳机制
    - _需求：10.1, 10.2, 7.2_

- [x] 19. 创建部署配置
  - [x] 19.1 完善 Docker Compose 配置
    - 配置所有服务（postgres、redis、api、frontend、admin）
    - 配置环境变量
    - 配置数据卷
    - 配置网络
    - _需求：13.1_
  
  - [x] 19.2 创建 Dockerfile
    - API 服务 Dockerfile（多阶段构建）
    - 前端 Dockerfile（Nginx）
    - 管理后台 Dockerfile（Nginx）
    - Node Agent Dockerfile
    - _需求：13.1_
  
  - [x] 19.3 创建节点部署脚本
    - 编写 install_node.sh 脚本
    - 自动安装 Xray-core
    - 自动安装 Node Agent
    - 配置 systemd 服务
    - _需求：13.2, 13.3_
  
  - [x] 19.4 创建数据库初始化脚本
    - SQL 迁移脚本
    - 初始数据（默认套餐）
    - _需求：13.5_
  
  - [x] 19.5 测试部署流程
    - 测试 Docker Compose 部署
    - 测试节点部署脚本
    - 测试数据库初始化
    - _需求：13.1, 13.2, 13.5_

- [x] 20. 实现安全加固
  - [x] 20.1 实现速率限制
    - 使用 Redis 实现速率限制中间件
    - 每用户每分钟最多 60 请求
    - _需求：14.3_
  
  - [x] 20.2 实现 CORS 配置
    - 配置允许的源
    - 配置允许的方法和头
    - _需求：14.5_
  
  - [x] 20.3 实现输入验证
    - 邮箱格式验证
    - 密码强度验证
    - SQL 注入防护（参数化查询）
    - XSS 防护
    - _需求：1.1, 14.3_
  
  - [x] 20.4 编写安全测试
    - 测试 SQL 注入防护
    - 测试 XSS 防护
    - 测试速率限制
    - _需求：14.3_

- [x] 21. 最终检查点 - 系统集成测试
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 22. 文档和部署指南
  - [ ] 22.1 编写 API 文档
    - 使用 OpenAPI/Swagger 规范
    - 文档化所有端点
    - 包含请求/响应示例
    - _需求：所有 API 相关需求_
  
  - [ ] 22.2 编写部署文档
    - 系统要求
    - 部署步骤
    - 环境变量说明
    - 故障排查指南
    - _需求：13.1, 13.2, 13.4_
  
  - [ ] 22.3 编写用户手册
    - 用户注册和登录
    - 购买套餐
    - 获取订阅链接
    - 配置 Clash 客户端
    - _需求：1.1, 3.2, 5.1_
  
  - [ ] 22.4 编写管理员手册
    - 节点管理
    - 用户管理
    - 数据统计
    - _需求：6.1, 8.1, 12.1_

## 注意事项

- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 所有测试任务都是必需的，以确保从一开始就有全面的测试覆盖
