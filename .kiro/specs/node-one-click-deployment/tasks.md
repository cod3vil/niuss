# 实现计划：节点一键部署功能

## 概述

本实现计划将节点一键部署功能分解为一系列可执行的编码任务。每个任务都建立在前面任务的基础上，最终实现一个完整的、可用的部署脚本。

实现策略：
- 采用增量开发方式，每个任务产生可测试的代码
- 优先实现核心功能，然后添加高级特性
- 在关键节点设置检查点，确保质量
- 测试任务标记为可选，以加快 MVP 开发

## 任务

- [x] 1. 创建脚本基础结构和工具函数
  - 创建 `scripts/deploy_node.sh` 文件
  - 实现颜色输出函数（print_info、print_warn、print_error）
  - 实现日志记录函数（log_info、log_warn、log_error、log_debug）
  - 实现敏感信息屏蔽函数（mask_sensitive）
  - 设置脚本头部（shebang、set -e、trap）
  - 定义全局配置变量和数据结构
  - _需求：10.1, 10.2, 12.3_

- [x] 1.1 编写基础工具函数的单元测试
  - 创建 `tests/test_deploy_node.bats` 文件
  - 测试日志函数的输出格式
  - 测试敏感信息屏蔽功能
  - **属性 11：敏感信息屏蔽**
  - **验证需求：12.3**

- [-] 2. 实现参数解析和验证
  - [x] 2.1 实现命令行参数解析函数
    - 解析 --api-url、--admin-token、--node-name 等参数
    - 支持 --help 显示使用说明
    - 支持 --verbose、--quiet、--force 等选项
    - 优先使用命令行参数，其次使用环境变量
    - _需求：1.1, 1.2, 1.3, 1.7_

  - [x] 2.2 实现参数验证函数
    - 验证必需参数是否提供
    - 验证 URL 格式
    - 验证端口范围（1-65535）
    - 验证协议类型（shadowsocks/vmess/trojan/hysteria2/vless）
    - 验证 JWT token 格式
    - _需求：1.1, 1.2, 1.3, 12.1_

  - [x] 2.3 实现默认值处理
    - NODE_PORT 默认为 443
    - NODE_PROTOCOL 默认为 vless
    - NODE_CONFIG 默认为空对象 {}
    - _需求：1.5, 1.6_

  - [ ] 2.4 编写参数解析的单元测试
    - 测试命令行参数解析
    - 测试环境变量解析
    - 测试参数优先级（命令行 > 环境变量）
    - 测试默认值
    - **属性 1：参数解析一致性**
    - **验证需求：1.1, 1.2, 1.3, 1.7**

  - [x] 2.5 编写参数验证的单元测试
    - 测试 JWT 格式验证
    - 测试无效参数的拒绝
    - **属性 10：Token 格式验证**
    - **验证需求：12.1**

- [x] 3. 实现环境检测和依赖检查
  - [x] 3.1 实现操作系统检测函数
    - 读取 /etc/os-release 文件
    - 识别 Ubuntu、CentOS、Debian
    - 提取版本号
    - _需求：2.1_

  - [x] 3.2 实现 root 权限检查
    - 检查 EUID 是否为 0
    - 显示错误信息并退出
    - _需求：2.2_

  - [x] 3.3 实现依赖检查函数
    - 检查 curl、jq、systemctl、openssl 等命令
    - 记录缺失的依赖
    - 尝试自动安装缺失的依赖（根据操作系统）
    - _需求：2.3, 2.4_

  - [x] 3.4 实现公网 IP 自动检测
    - 尝试多个 IP 检测服务（ipify、icanhazip、ifconfig.me）
    - 实现重试和降级机制
    - _需求：1.4_

  - [x] 3.5 编写环境检测的单元测试
    - 测试操作系统识别
    - 测试依赖检查
    - **属性 2：操作系统检测准确性**
    - **属性 3：依赖检查完整性**
    - **验证需求：2.1, 2.3**

- [ ] 4. 检查点 - 验证基础功能
  - 确保所有测试通过
  - 验证脚本可以正确解析参数
  - 验证环境检测功能正常
  - 询问用户是否有问题

- [x] 5. 实现节点密钥生成
  - [x] 5.1 实现密钥生成函数
    - 使用 openssl rand 生成 32 字节随机数据
    - 转换为 base64 并清理特殊字符
    - 确保长度至少 32 字符
    - 仅包含字母数字字符
    - _需求：3.1, 3.3_

  - [x] 5.2 编写密钥生成的单元测试
    - 测试密钥长度（>= 32）
    - 测试密钥格式（仅字母数字）
    - 测试多次生成的唯一性
    - **属性 4：密钥生成安全性**
    - **验证需求：3.1, 3.3**

- [ ] 6. 实现 API 客户端
  - [x] 6.1 实现节点创建 API 调用
    - 构建 JSON 请求体
    - 发送 POST 请求到 /api/admin/nodes
    - 包含 Authorization 头
    - 解析 HTTP 响应码和响应体
    - 提取 node_id 和 secret
    - _需求：4.1, 4.2, 4.3, 4.4_

  - [x] 6.2 实现 API 错误处理
    - 处理 401/403 认证错误
    - 处理 400 参数错误
    - 处理 409 冲突错误
    - 处理 500 服务器错误
    - 处理网络错误
    - 实现重试机制（最多 3 次）
    - _需求：4.5, 4.6_

  - [x] 6.3 编写 API 客户端的单元测试
    - 使用 mock API 响应测试解析
    - 测试错误处理
    - **属性 5：API 响应解析正确性**
    - **验证需求：4.4**

- [x] 7. 实现 Xray-core 安装
  - [x] 7.1 实现 Xray-core 下载和安装
    - 调用官方安装脚本
    - 验证安装成功
    - 启用 systemd 服务
    - _需求：5.1, 5.2, 5.3, 5.4_

  - [x] 7.2 实现 Xray-core 配置生成
    - 根据协议类型生成配置
    - 支持 vless、vmess、trojan、shadowsocks、hysteria2
    - 写入配置文件到 /etc/xray/config.json
    - _需求：5.5_

  - [x] 7.3 编写配置生成的单元测试
    - 测试不同协议的配置生成
    - 验证配置文件格式
    - **属性 6：协议配置生成正确性**
    - **验证需求：5.5**

- [x] 8. 实现 Node Agent 安装
  - [x] 8.1 实现 Node Agent 下载
    - 检测系统架构（x86_64/aarch64）
    - 下载对应架构的二进制文件
    - 验证下载完整性
    - 设置执行权限
    - 安装到 /usr/local/bin
    - _需求：6.1, 6.2_

  - [x] 8.2 实现 Node Agent 配置
    - 创建配置目录 /etc/node-agent
    - 生成配置文件 config.env
    - 包含 API_URL、NODE_ID、NODE_SECRET
    - 设置文件权限为 600
    - _需求：6.3, 12.2_

  - [x] 8.3 实现 systemd 服务创建
    - 创建 node-agent.service 文件
    - 配置服务依赖和重启策略
    - 配置安全设置
    - 启用开机自启动
    - _需求：6.4, 6.5_

- [-] 9. 实现服务启动和验证
  - [x] 9.1 实现服务启动函数
    - 重载 systemd 配置
    - 启动 node-agent 服务
    - 等待服务启动
    - _需求：7.1, 7.2_

  - [x] 9.2 实现部署验证函数
    - 检查服务状态（active/running）
    - 检查端口监听
    - 检查 API 连接
    - 检查日志中的错误
    - _需求：7.3, 7.4, 7.5_

  - [x] 9.3 实现错误处理和故障排查
    - 显示服务日志
    - 提供故障排查建议
    - _需求：7.6_

- [ ] 10. 检查点 - 验证核心部署流程
  - 确保所有测试通过
  - 手动测试单节点部署
  - 验证服务正常启动
  - 询问用户是否有问题

- [x] 11. 实现批量部署功能
  - [x] 11.1 实现批量配置文件解析
    - 支持 YAML 格式配置文件
    - 使用 yq 或 jq 解析配置
    - 提取 API 配置和节点列表
    - _需求：8.1_

  - [x] 11.2 实现批量部署循环
    - 遍历节点列表
    - 为每个节点调用部署函数
    - 记录每个节点的部署结果
    - 继续部署即使某个节点失败
    - _需求：8.2, 8.4, 8.5_

  - [x] 11.3 实现部署摘要报告
    - 统计成功和失败数量
    - 显示每个节点的状态
    - 生成详细报告
    - _需求：8.6_

  - [x] 11.4 编写批量部署的单元测试
    - 测试配置文件解析
    - 测试密钥唯一性
    - **属性 7：批量配置解析正确性**
    - **属性 8：密钥唯一性**
    - **验证需求：8.1, 8.3**

- [x] 12. 实现节点更新和重新部署
  - [x] 12.1 实现节点存在检测
    - 检查配置文件是否存在
    - 检查服务是否已安装
    - _需求：9.1_

  - [x] 12.2 实现更新模式
    - 询问用户是否更新
    - 保留现有 NODE_ID 和 NODE_SECRET
    - 更新配置文件
    - 重启服务
    - _需求：9.2, 9.5_

  - [x] 12.3 实现重新部署模式
    - 停止现有服务
    - 备份配置文件
    - 执行完整部署流程
    - _需求：9.3, 9.4_

  - [x] 12.4 实现强制部署选项
    - 支持 --force 参数
    - 跳过用户确认
    - 直接重新部署
    - _需求：9.6_

- [x] 13. 实现幂等性和回滚机制
  - [x] 13.1 实现组件检测和跳过
    - 检测已安装的 Xray-core
    - 检测已安装的 Node Agent
    - 跳过重复安装
    - 仅更新配置
    - _需求：11.1, 11.2_

  - [x] 13.2 实现错误回滚
    - 在错误时停止服务
    - 恢复备份的配置
    - 清理部分安装的文件
    - _需求：11.3, 11.4_

  - [x] 13.3 实现清理和回滚命令
    - 提供清理命令
    - 支持 --rollback 参数
    - 恢复到上一个稳定版本
    - _需求：11.5, 11.6_

  - [x] 13.4 编写幂等性测试
    - 测试重复执行的行为
    - 验证跳过已安装组件
    - **属性 9：幂等性**
    - **验证需求：11.1**

- [x] 14. 实现安全增强
  - [x] 14.1 实现配置文件权限设置
    - 设置配置文件权限为 600
    - 验证文件权限
    - _需求：12.2_

  - [x] 14.2 实现 HTTPS 验证
    - 验证 API_URL 使用 HTTPS
    - 验证 SSL 证书
    - _需求：12.4_

  - [x] 14.3 实现配置文件权限检查
    - 检查批量配置文件权限
    - 拒绝权限过宽的文件
    - _需求：12.5_

  - [x] 14.4 实现临时文件清理
    - 清理包含敏感信息的临时文件
    - 在脚本退出时自动清理
    - _需求：12.6_

- [ ] 15. 实现详细日志和调试支持
  - [x] 15.1 实现日志文件写入
    - 写入所有操作到 /var/log/node-deployment.log
    - 包含时间戳和日志级别
    - _需求：10.1_

  - [x] 15.2 实现详细模式和静默模式
    - 支持 --verbose 参数
    - 支持 --quiet 参数
    - 控制输出详细程度
    - _需求：10.5, 10.6_

  - [x] 15.3 实现错误日志和建议
    - 记录详细错误信息
    - 提供解决方案建议
    - 实现故障排查提示函数
    - _需求：10.3, 10.4_

- [x] 16. 检查点 - 完整功能测试
  - 确保所有测试通过
  - 测试单节点部署
  - 测试批量部署
  - 测试更新和重新部署
  - 测试错误处理和回滚
  - 询问用户是否有问题

- [ ] 17. 创建文档和示例
  - [ ] 17.1 创建使用文档
    - 编写 README 说明
    - 提供使用示例
    - 说明参数和选项
    - 创建 `docs/deploy_node_usage.md`

  - [ ] 17.2 创建批量配置示例
    - 提供 YAML 配置示例
    - 说明配置格式
    - 创建 `examples/batch_deploy.yaml`

  - [ ] 17.3 创建故障排查指南
    - 列出常见问题
    - 提供解决方案
    - 创建 `docs/troubleshooting.md`

- [ ] 18. 集成测试
  - [ ] 18.1 创建 Docker 测试环境
    - 创建 Ubuntu 测试容器
    - 创建 CentOS 测试容器
    - 创建 mock API 服务器

  - [ ] 18.2 编写端到端测试
    - 测试完整部署流程
    - 测试不同操作系统
    - 测试批量部署
    - 测试错误场景

- [ ] 19. 最终检查点
  - 运行所有测试
  - 验证文档完整性
  - 进行代码审查
  - 确认所有需求已实现

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，确保可追溯性
- 检查点任务确保增量验证和质量控制
- 测试任务使用 Bats 框架，每个属性测试都标注了对应的属性编号
- 优先实现核心功能，高级特性可以后续迭代

## 实现顺序说明

1. **阶段 1（任务 1-4）：** 基础设施 - 脚本框架、参数处理、环境检测
2. **阶段 2（任务 5-10）：** 核心功能 - 密钥生成、API 调用、安装部署
3. **阶段 3（任务 11-13）：** 高级功能 - 批量部署、更新、幂等性
4. **阶段 4（任务 14-16）：** 完善和优化 - 安全、日志、测试
5. **阶段 5（任务 17-19）：** 文档和发布 - 文档、集成测试、最终验证
